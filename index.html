<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trypanosoma brucei Life Cycle Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1020;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 1.5rem 2rem 1rem;
      background: linear-gradient(135deg, #111827, #1f2937);
      border-bottom: 1px solid #374151;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      gap: 1rem;
    }

    .mode-switch {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .btn {
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .btn:hover {
      background: #1f2937;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }

    .btn.active {
      background: #2563eb;
      border-color: #2563eb;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(220px, 280px) minmax(0, 1fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .timeline {
      background: #020617;
      border-radius: 1rem;
      border: 1px solid #111827;
      padding: 0.75rem;
      max-height: 80vh;
      overflow-y: auto;
    }

    .timeline-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .timeline-sub {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.75rem;
    }

    .stage-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.5rem;
      margin-bottom: 0.35rem;
      border-radius: 0.7rem;
      cursor: pointer;
      transition: background 0.1s ease, border-color 0.1s ease;
      border: 1px solid transparent;
    }

    .stage-item:hover {
      background: #020617;
      border-color: #1f2937;
    }

    .stage-item.active {
      background: #111827;
      border-color: #2563eb;
    }

    .stage-number {
      width: 1.3rem;
      height: 1.3rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #9ca3af;
      flex-shrink: 0;
    }

    .stage-text {
      font-size: 0.8rem;
    }

    .stage-text strong {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.15rem;
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 1rem;
      border: 1px solid #1f2937;
      padding: 1rem 1.2rem 1.2rem;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      min-height: 260px;
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.35rem;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.8);
    }

    .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-top: 0.3rem;
    }

    .value {
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .bullet-list {
      margin: 0.3rem 0 0.4rem;
      padding-left: 1.1rem;
      font-size: 0.8rem;
    }

    .bullet-list li {
      margin-bottom: 0.18rem;
    }

    .flow {
      margin-top: 0.6rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    /* CDC images block inside timeline */
    .timeline-images {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #111827;
    }

    .media-grid {
      margin-top: 0.5rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .media-item {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid #111827;
      padding: 0.4rem;
      text-align: center;
    }

    .media-item img {
      max-width: 100%;
      border-radius: 0.6rem;
      display: block;
      margin: 0 auto 0.3rem;
    }

    .media-caption {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    /* Quiz */
    .quiz-question {
      margin: 0.3rem 0 0.5rem;
      font-size: 0.95rem;
    }

    .quiz-desc {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.45rem;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
    }

    .quiz-option {
      padding: 0.4rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid #4b5563;
      cursor: pointer;
      font-size: 0.85rem;
      background: #020617;
      color: #ffffff; /* readable white text */
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
      text-align: left;
    }

    .quiz-option:hover {
      background: #111827;
      transform: translateY(-1px);
    }

    .quiz-option.correct {
      border-color: #16a34a;
      background: rgba(22, 163, 74, 0.25);
      color: #ffffff;
    }

    .quiz-option.incorrect {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.25);
      color: #ffffff;
    }

    .quiz-feedback {
      font-size: 0.8rem;
      margin-bottom: 0.4rem;
      min-height: 1.2em;
    }

    .quiz-feedback.correct {
      color: #4ade80;
    }

    .quiz-feedback.incorrect {
      color: #f97373;
    }

    .quiz-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.2rem;
    }

    footer {
      font-size: 0.7rem;
      color: #6b7280;
      padding: 0.75rem 1.5rem 1rem;
      border-top: 1px solid #111827;
      text-align: right;
    }

    /* WHY IT MATTERS PANEL */
    .why-section {
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .why-section h3 {
      margin-top: 0.7rem;
      margin-bottom: 0.2rem;
      font-size: 0.95rem;
    }

    .why-section p {
      margin: 0.2rem 0 0.4rem;
    }

    .why-highlight {
      background: rgba(37, 99, 235, 0.18);
      border-radius: 0.75rem;
      border: 1px solid rgba(37, 99, 235, 0.6);
      padding: 0.55rem 0.7rem;
      font-size: 0.8rem;
      margin-bottom: 0.6rem;
    }

    .why-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.2rem;
    }

    .why-chip {
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }
  </style>
</head>
<body>
<header>
  <h1>Trypanosoma brucei Life Cycle Explorer</h1>
  <p>Interactive overview of African trypanosomiasis (sleeping sickness): stages, ecology, and quiz.</p>
</header>

<main>
  <div class="mode-switch">
    <button id="mode-explore" class="btn active">Explore Life Cycle</button>
    <button id="mode-quiz" class="btn">Quiz Mode</button>
    <button id="mode-why" class="btn">Why It Matters</button>
  </div>

  <div class="layout">
    <!-- SIDEBAR: TIMELINE + CDC PICS -->
    <aside class="timeline">
      <div class="timeline-title">Life Cycle Timeline</div>
      <div class="timeline-sub">
        Condensed stages of African trypanosomes in the mammalian host and tsetse fly vector.
      </div>
      <div id="stage-list"></div>

      <div class="timeline-images">
        <div class="label">CDC reference images</div>
        <div class="media-grid">
          <div class="media-item">
            <a href="https://www.cdc.gov/dpdx/trypanosomiasisafrican/index.html" target="_blank" rel="noreferrer">
              <img
                src="https://www.cdc.gov/dpdx/trypanosomiasisafrican/modules/SleepingSick_LifeCycle_19.jpg"
                alt="CDC life cycle diagram of African trypanosomiasis"
              />
            </a>
            <div class="media-caption">
              CDC DPDx: African trypanosomiasis life cycle diagram.
            </div>
          </div>
          <div class="media-item">
            <a href="https://www.cdc.gov/dpdx/trypanosomiasisafrican/index.html#Images" target="_blank" rel="noreferrer">
              <img
                src="https://www.cdc.gov/dpdx/trypanosomiasisafrican/images/2/Figure-A.jpg"
                alt="Trypanosoma brucei trypomastigote in a blood smear, CDC DPDx"
              />
            </a>
            <div class="media-caption">
              CDC DPDx: <em>T. brucei</em> trypomastigote in Giemsa-stained blood.
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN PANEL: EXPLORE -->
    <section id="panel-explore" class="card">
      <h2 id="stage-title">Select a stage</h2>
      <div class="pill-row" id="stage-pills"></div>

      <div class="label">Host</div>
      <div class="value" id="stage-host">—</div>

      <div class="label">Anatomical location</div>
      <div class="value" id="stage-location">—</div>

      <div class="label">What happens here?</div>
      <ul class="bullet-list" id="stage-keypoints"></ul>

      <div class="label">Clinical / epidemiological notes</div>
      <ul class="bullet-list" id="stage-notes"></ul>

      <div class="flow" id="stage-flow"></div>
    </section>

    <!-- MAIN PANEL: QUIZ -->
    <section id="panel-quiz" class="card" style="display:none;">
      <h2>Quiz</h2>
      <p class="quiz-desc">
        Multiple-choice practice on <em>T. brucei</em>, its vectors, and key clinical features.
      </p>
      <div class="quiz-question" id="quiz-question-text"></div>
      <div class="quiz-desc" id="quiz-question-extra"></div>
      <div class="quiz-options" id="quiz-options"></div>
      <div class="quiz-feedback" id="quiz-feedback"></div>

      <button class="btn" id="quiz-next">Next Question</button>
      <div class="quiz-meta" id="quiz-meta"></div>
    </section>

    <!-- MAIN PANEL: WHY IT MATTERS -->
    <section id="panel-why" class="card" style="display:none;">
      <h2>Why It Matters: Ecology, Climate, and Burden</h2>
      <div class="why-section">
        <div class="why-highlight">
          <strong>Sleeping sickness is almost always fatal without treatment.</strong>
          It is caused by <em>Trypanosoma brucei</em> and spread by tsetse flies in
          rural, sub-Saharan Africa. Communities that rely on farming, herding,
          fishing, and hunting live and work where these flies thrive.
        </div>

        <h3>Where the parasite lives</h3>
        <p>
          According to CDC and DPDx, human African trypanosomiasis only occurs in
          <strong>sub-Saharan Africa</strong>. Two subspecies dominate the map:
        </p>
        <ul class="bullet-list">
          <li>
            <strong><em>T. b. gambiense</em></strong> – endemic in
            <strong>West and Central Africa</strong>; historically responsible for
            most reported human cases.
          </li>
          <li>
            <strong><em>T. b. rhodesiense</em></strong> – restricted to
            <strong>East and Southeast Africa</strong>, with foci in countries like
            Tanzania, Zambia, Zimbabwe, Malawi, and Uganda.
          </li>
        </ul>
        <p>
          Tsetse flies that transmit these parasites live in
          <strong>woodlands, savannah thickets, and riverine forests</strong>,
          often far from cities but very close to cattle, wildlife, and people working
          the land.
        </p>

        <div class="why-chip-row">
          <span class="why-chip">Sub-Saharan Africa only</span>
          <span class="why-chip">Rural &amp; riverine habitats</span>
          <span class="why-chip">Wildlife–livestock–human interface</span>
        </div>

        <h3>Parasite ecology: a One Health system</h3>
        <p>
          The ecology of <em>T. brucei</em> is a classic One Health problem:
          <strong>parasite, vector, wildlife, livestock, and humans are all linked.</strong>
        </p>
        <ul class="bullet-list">
          <li>
            Tsetse flies feed on multiple hosts – wild animals, cattle, and humans –
            acting as a bridge for parasites between species.
          </li>
          <li>
            For <em>T. b. gambiense</em>, humans are a key reservoir; for
            <em>T. b. rhodesiense</em>, cattle and wildlife play a major reservoir role.
          </li>
          <li>
            Land use (clearing forests, expanding farms, building roads) changes
            tsetse habitat, which can shrink some foci and create new edges of risk
            where people and flies newly overlap.
          </li>
        </ul>

        <h3>Climate change and shifting risk</h3>
        <p>
          Tsetse flies are highly sensitive to temperature, humidity, and vegetation.
          Studies modeling climate trends in endemic regions show that:
        </p>
        <ul class="bullet-list">
          <li>
            <strong>Rising temperatures</strong> can make some current lowland habitats
            too hot and dry for tsetse, reducing fly survival there.
          </li>
          <li>
            At the same time, <strong>higher elevation zones</strong> that used to be
            too cool are becoming more suitable, allowing tsetse populations to expand
            into new areas that historically had little or no risk.
          </li>
          <li>
            These shifts can move risk toward new communities and livestock systems,
            while also changing where control programs need to focus their resources.
          </li>
        </ul>
        <p>
          Climate change doesn’t create the parasite – it <strong>reshuffles the
          playing field</strong>. Areas that relied on altitude or cooler temperatures
          as a natural “shield” may lose that protection, while other regions may see
          declining risk. Public health surveillance and vector control have to adapt
          to these moving ecological boundaries.
        </p>

        <h3>Why this tool matters for students &amp; public health</h3>
        <p>
          Most maps label sleeping sickness as “sub-Saharan Africa” and stop there.
          This tool forces users to connect:
        </p>
        <ul class="bullet-list">
          <li>
            <strong>Stage-by-stage parasite biology</strong> – where the parasite is in
            the human vs. in the fly.
          </li>
          <li>
            <strong>Ecology of transmission</strong> – tsetse habitat, hosts, and land use.
          </li>
          <li>
            <strong>Real-world health burden</strong> – who is actually at risk and why
            rural, poor communities carry most of the weight.
          </li>
        </ul>
        <p>
          For parasitology, global health, or ecology students, this is not just a
          life cycle diagram – it’s a way to visualize how
          <strong>climate, geography, and human behavior</strong> interact with a
          vector-borne parasite that is still capable of outbreak and re-emergence
          if surveillance and control lapse.
        </p>
      </div>
    </section>
  </div>
</main>

<footer>
  Educational tool for parasitology – African trypanosomiasis (sleeping sickness).
</footer>

<script>
  /* ---------- LIFE CYCLE STAGES (condensed from CDC/DPDx description) ---------- */
  const stages = [
    {
      id: "1",
      order: 1,
      name: "Metacyclic trypomastigote (infective form)",
      short: "Metacyclic trypomastigote",
      host: "Tsetse fly (Glossina spp.) → Mammalian host",
      location: "Salivary glands of tsetse fly; injected into skin and bloodstream during bite",
      type: "Infective stage for humans",
      keyPoints: [
        "Injected during the tsetse fly blood meal on a mammalian host.",
        "Parasites enter skin tissue, then move into the lymphatic system and bloodstream.",
        "Marks the beginning of human infection in the life cycle."
      ],
      notes: [
        "Can be associated with a local sore (trypanosomal chancre) at the bite site.",
        "First step toward systemic disease and later CNS invasion."
      ],
      flow: "Tsetse salivary gland → human skin → lymphatic system → bloodstream."
    },
    {
      id: "2",
      order: 2,
      name: "Bloodstream trypomastigote",
      short: "Bloodstream trypomastigote",
      host: "Mammalian host (human or animal reservoir)",
      location: "Blood and other body fluids, including lymph and spinal fluid",
      type: "Diagnostic & proliferative stage in humans",
      keyPoints: [
        "Metacyclic forms transform into bloodstream trypomastigotes.",
        "Parasites multiply by binary fission in blood and other body fluids.",
        "All stages in humans are extracellular."
      ],
      notes: [
        "This is the form detected on blood smears for diagnosis.",
        "In late disease, parasites invade the CNS and cause neurologic symptoms."
      ],
      flow: "Bloodstream and body fluids → ingested by tsetse fly during blood meal."
    },
    {
      id: "3",
      order: 3,
      name: "Procyclic trypomastigote (midgut form)",
      short: "Procyclic trypomastigote",
      host: "Tsetse fly",
      location: "Midgut of the tsetse fly",
      type: "Proliferative vector stage",
      keyPoints: [
        "Tsetse flies become infected when they ingest bloodstream trypomastigotes.",
        "In the fly midgut, parasites transform into procyclic trypomastigotes.",
        "Procyclic forms multiply by binary fission before leaving the midgut."
      ],
      notes: [
        "Not infective for mammals; part of the fly-side cycle.",
        "Successful midgut colonization is required for further development."
      ],
      flow: "Ingested bloodstream trypomastigotes → procyclic forms in midgut."
    },
    {
      id: "4",
      order: 4,
      name: "Epimastigote (salivary gland form)",
      short: "Epimastigote",
      host: "Tsetse fly",
      location: "Proventriculus and salivary glands of the fly",
      type: "Replicating stage in salivary glands",
      keyPoints: [
        "Procyclic forms leave the midgut and transform into epimastigotes.",
        "Epimastigotes migrate to the salivary glands.",
        "They continue to multiply by binary fission in the glands."
      ],
      notes: [
        "Bridges midgut replication and the final infective stage.",
        "Part of a roughly 3-week developmental cycle in the fly."
      ],
      flow: "Midgut → proventriculus → salivary glands."
    },
    {
      id: "5",
      order: 5,
      name: "Metacyclic trypomastigote (ready for next host)",
      short: "Metacyclic trypomastigote (mature)",
      host: "Tsetse fly → new mammalian host",
      location: "Salivary glands of an infected tsetse fly",
      type: "Final vector stage, infective to mammals",
      keyPoints: [
        "Epimastigotes differentiate into metacyclic trypomastigotes.",
        "These metacyclic forms are infective for mammals.",
        "They are injected during the fly’s next blood meal."
      ],
      notes: [
        "A single infected fly can transmit to multiple hosts over its life.",
        "Maintains transmission in rural areas with humans and animal reservoirs."
      ],
      flow: "Epimastigotes in salivary glands → metacyclic forms → new mammalian host."
    }
  ];

  /* ---------- QUIZ QUESTIONS (CDC-style facts) ---------- */
  const quizQuestions = [
    {
      question: "What parasite causes human African trypanosomiasis (sleeping sickness)?",
      extra: "",
      options: [
        "Trypanosoma brucei",
        "Trypanosoma cruzi",
        "Plasmodium falciparum",
        "Leishmania donovani"
      ],
      correctIndex: 0,
      explanation: "Sleeping sickness is caused by Trypanosoma brucei species."
    },
    {
      question: "What insect vector transmits African trypanosomes to humans?",
      extra: "",
      options: [
        "Tsetse fly (Glossina spp.)",
        "Anopheles mosquito",
        "Sand fly",
        "Hard tick"
      ],
      correctIndex: 0,
      explanation: "The only known vector for human African trypanosomiasis is the tsetse fly."
    },
    {
      question: "Where are tsetse flies that spread sleeping sickness found?",
      extra: "",
      options: [
        "Rural areas of sub-Saharan Africa",
        "Every continent worldwide",
        "South America only",
        "Southeast Asia only"
      ],
      correctIndex: 0,
      explanation: "Transmission occurs in rural parts of sub-Saharan Africa where tsetse flies live."
    },
    {
      question: "Which subspecies is typically associated with West African sleeping sickness?",
      extra: "",
      options: [
        "Trypanosoma brucei gambiense",
        "Trypanosoma brucei rhodesiense",
        "Trypanosoma cruzi",
        "Trypanosoma brucei brucei"
      ],
      correctIndex: 0,
      explanation: "T. b. gambiense is responsible for most West and Central African human cases."
    },
    {
      question: "Which subspecies usually causes a faster-progressing East African disease?",
      extra: "",
      options: [
        "Trypanosoma brucei rhodesiense",
        "Trypanosoma brucei gambiense",
        "Plasmodium vivax",
        "Leishmania tropica"
      ],
      correctIndex: 0,
      explanation: "T. b. rhodesiense typically produces an acute, rapidly progressing illness."
    },
    {
      question: "How many main clinical stages are recognized in human African trypanosomiasis?",
      extra: "",
      options: [
        "Two: early hemolymphatic stage and CNS (meningoencephalitic) stage",
        "One single acute stage only",
        "Three including a liver-only stage",
        "Four distinct chronic stages"
      ],
      correctIndex: 0,
      explanation: "There are two main stages; the second involves the central nervous system."
    },
    {
      question: "Which of the following is a typical early (first-stage) manifestation?",
      extra: "",
      options: [
        "Fever, headache, and sometimes a sore at the tsetse bite site",
        "Sudden total blindness only",
        "Chronic kidney failure without other symptoms",
        "Isolated toe pain"
      ],
      correctIndex: 0,
      explanation: "Early disease often includes fever, headache, and a chancre at the bite site."
    },
    {
      question: "Which symptom reflects central nervous system involvement in later-stage disease?",
      extra: "",
      options: [
        "Disturbance of the sleep–wake cycle",
        "Mild hand rash only",
        "Toothache only",
        "Short-term ankle sprain"
      ],
      correctIndex: 0,
      explanation: "Second-stage disease includes sleep–wake disruption and neuropsychiatric symptoms."
    },
    {
      question: "In which morphologic form is T. brucei typically seen on blood smear?",
      extra: "",
      options: [
        "Extracellular trypomastigote with undulating membrane",
        "Intracellular amastigote in red blood cells",
        "Ring forms inside hepatocytes",
        "Egg with an operculum"
      ],
      correctIndex: 0,
      explanation: "On smear it appears as an extracellular trypomastigote with a flagellum and undulating membrane."
    },
    {
      question: "What is the main reservoir for T. brucei gambiense in many endemic areas?",
      extra: "",
      options: [
        "Humans",
        "Freshwater snails",
        "Mosquitoes",
        "Fish"
      ],
      correctIndex: 0,
      explanation: "Humans are an important reservoir for T. b. gambiense, sustaining transmission."
    }
  ];

  /* ---------- DOM HOOKS ---------- */
  const stageListEl = document.getElementById("stage-list");
  const stageTitleEl = document.getElementById("stage-title");
  const stagePillsEl = document.getElementById("stage-pills");
  const stageHostEl = document.getElementById("stage-host");
  const stageLocationEl = document.getElementById("stage-location");
  const stageKeypointsEl = document.getElementById("stage-keypoints");
  const stageNotesEl = document.getElementById("stage-notes");
  const stageFlowEl = document.getElementById("stage-flow");

  const panelExplore = document.getElementById("panel-explore");
  const panelQuiz = document.getElementById("panel-quiz");
  const panelWhy = document.getElementById("panel-why");

  const modeExploreBtn = document.getElementById("mode-explore");
  const modeQuizBtn = document.getElementById("mode-quiz");
  const modeWhyBtn = document.getElementById("mode-why");

  const quizQuestionText = document.getElementById("quiz-question-text");
  const quizQuestionExtra = document.getElementById("quiz-question-extra");
  const quizOptionsEl = document.getElementById("quiz-options");
  const quizFeedbackEl = document.getElementById("quiz-feedback");
  const quizNextBtn = document.getElementById("quiz-next");
  const quizMetaEl = document.getElementById("quiz-meta");

  const STORAGE_KEY = "tbruceiQuizStats_v1";

  let selectedStageId = null;
  let quizState = { index: 0, correct: 0, total: 0, locked: false };

  /* ---------- LOCAL STORAGE HELPERS ---------- */
  function loadQuizStatsFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (
        typeof data.correct === "number" &&
        typeof data.total === "number" &&
        data.correct >= 0 &&
        data.total >= 0
      ) {
        quizState.correct = data.correct;
        quizState.total = data.total;
      }
    } catch (e) {
      // ignore if storage is blocked or malformed
    }
  }

  function saveQuizStatsToStorage() {
    try {
      const payload = {
        correct: quizState.correct,
        total: quizState.total
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch (e) {
      // ignore if storage not available
    }
  }

  /* ---------- RENDER TIMELINE ---------- */
  function renderStageList() {
    stageListEl.innerHTML = "";
    stages
      .slice()
      .sort((a, b) => a.order - b.order)
      .forEach(stage => {
        const item = document.createElement("div");
        item.className = "stage-item";
        item.dataset.id = stage.id;

        const num = document.createElement("div");
        num.className = "stage-number";
        num.textContent = stage.order;

        const text = document.createElement("div");
        text.className = "stage-text";
        text.innerHTML = `<strong>${stage.short}</strong>${stage.host}`;

        item.appendChild(num);
        item.appendChild(text);

        item.addEventListener("click", () => {
          selectStage(stage.id);
        });

        stageListEl.appendChild(item);
      });
  }

  function selectStage(stageId) {
    selectedStageId = stageId;
    const stage = stages.find(s => s.id === stageId);
    if (!stage) return;

    document.querySelectorAll(".stage-item").forEach(el => {
      el.classList.toggle("active", el.dataset.id === stageId);
    });

    stageTitleEl.textContent = stage.name;

    stagePillsEl.innerHTML = "";
    const pill1 = document.createElement("div");
    pill1.className = "pill";
    pill1.textContent = stage.type;
    stagePillsEl.appendChild(pill1);

    const pill2 = document.createElement("div");
    pill2.className = "pill";
    pill2.textContent = `Stage ${stage.order}`;
    stagePillsEl.appendChild(pill2);

    stageHostEl.textContent = stage.host;
    stageLocationEl.textContent = stage.location;

    stageKeypointsEl.innerHTML = "";
    stage.keyPoints.forEach(pt => {
      const li = document.createElement("li");
      li.textContent = pt;
      stageKeypointsEl.appendChild(li);
    });

    stageNotesEl.innerHTML = "";
    stage.notes.forEach(pt => {
      const li = document.createElement("li");
      li.textContent = pt;
      stageNotesEl.appendChild(li);
    });

    stageFlowEl.textContent = stage.flow || "";
  }

  /* ---------- MODE SWITCH ---------- */
  function setMode(mode) {
    if (mode === "explore") {
      panelExplore.style.display = "block";
      panelQuiz.style.display = "none";
      panelWhy.style.display = "none";
      modeExploreBtn.classList.add("active");
      modeQuizBtn.classList.remove("active");
      modeWhyBtn.classList.remove("active");
    } else if (mode === "quiz") {
      panelExplore.style.display = "none";
      panelQuiz.style.display = "block";
      panelWhy.style.display = "none";
      modeExploreBtn.classList.remove("active");
      modeQuizBtn.classList.add("active");
      modeWhyBtn.classList.remove("active");
      loadQuizQuestion();
    } else if (mode === "why") {
      panelExplore.style.display = "none";
      panelQuiz.style.display = "none";
      panelWhy.style.display = "block";
      modeExploreBtn.classList.remove("active");
      modeQuizBtn.classList.remove("active");
      modeWhyBtn.classList.add("active");
    }
  }

  modeExploreBtn.addEventListener("click", () => setMode("explore"));
  modeQuizBtn.addEventListener("click", () => setMode("quiz"));
  modeWhyBtn.addEventListener("click", () => setMode("why"));

  /* ---------- QUIZ LOGIC (fixed question bank) ---------- */
  function loadQuizQuestion() {
    quizState.locked = false;
    quizFeedbackEl.textContent = "";
    quizFeedbackEl.className = "quiz-feedback";

    const q = quizQuestions[quizState.index];
    quizQuestionText.textContent = q.question;
    quizQuestionExtra.textContent = q.extra || "";
    quizOptionsEl.innerHTML = "";

    q.options.forEach((opt, idx) => {
      const btn = document.createElement("button");
      btn.className = "quiz-option";
      btn.textContent = opt;
      btn.addEventListener("click", () =>
        handleQuizAnswer(btn, idx, q.correctIndex, q.explanation)
      );
      quizOptionsEl.appendChild(btn);
    });

    updateQuizMeta();
  }

  function handleQuizAnswer(button, chosenIndex, correctIndex, explanation) {
    if (quizState.locked) return;
    quizState.locked = true;
    quizState.total += 1;

    const allBtns = quizOptionsEl.querySelectorAll(".quiz-option");
    allBtns.forEach(b => (b.disabled = true));

    if (chosenIndex === correctIndex) {
      button.classList.add("correct");
      quizFeedbackEl.textContent = "Correct. " + explanation;
      quizFeedbackEl.classList.add("correct");
      quizState.correct += 1;
    } else {
      button.classList.add("incorrect");
      quizFeedbackEl.textContent = "Not quite. " + explanation;
      quizFeedbackEl.classList.add("incorrect");
      allBtns.forEach((b, idx) => {
        if (idx === correctIndex) b.classList.add("correct");
      });
    }

    saveQuizStatsToStorage();
    updateQuizMeta();
  }

  function updateQuizMeta() {
    const qNumber = quizState.index + 1;
    quizMetaEl.textContent =
      "Question " +
      qNumber +
      " of " +
      quizQuestions.length +
      " • Cumulative score: " +
      quizState.correct +
      " / " +
      quizState.total;
  }

  quizNextBtn.addEventListener("click", () => {
    quizState.index = (quizState.index + 1) % quizQuestions.length;
    loadQuizQuestion();
  });

  /* ---------- INIT ---------- */
  loadQuizStatsFromStorage();
  renderStageList();
  if (stages.length > 0) {
    selectStage(stages[0].id);
  }
  // Prep first quiz question so Quiz tab is ready the first time you click it
  loadQuizQuestion();
</script>
</body>
</html>

